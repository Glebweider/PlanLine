import { useState } from 'react';

import style from './DeleteProjectModal.module.scss';
import { useAlert } from '../../Alert/context';
import { IProjectPreviewCard } from '../../../pages/ProjectsPage';


interface DeleteProjectModalProps {
    isOpen: boolean;
    projectId: string;
    projectTitle: string;
    onClose: () => void;
    setProjects: React.Dispatch<React.SetStateAction<IProjectPreviewCard[]>>;
}

const DeleteProjectModal: React.FC<DeleteProjectModalProps> = ({
    isOpen,
    projectId,
    projectTitle,
    onClose,
    setProjects
}) => {
    const { showAlert } = useAlert();

    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [isDeleting, setIsDeleting] = useState<boolean>(false);
    const [countDeleteClick, setCountDeleteClick] = useState<number>(3);

    const deleteProject = async () => {
        if (isLoading) return;

        setIsLoading(true);

        try {
            const response = await fetch(
                `${process.env.REACT_APP_BACKEND_URI}/projects/${projectId}`,
                {
                    method: 'Delete',
                    credentials: 'include',
                }
            );

            if (!response.ok) {
                const data = await response.json();
                showAlert(`Server error: ${response.status}, ${data.message}`);
                return;
            }

            setIsDeleting(true);
            setTimeout(() => {
                onClose();
                setProjects(prev => prev.filter(project => project.id !== projectId));
            }, 2000)
        } catch (error) {
            showAlert(`Error: ${error}`);
        } finally {
            setIsLoading(false);
        }
    };

    if (!isOpen) return <></>;

    return (
        <div className="modalOverlay" onClick={() => { onClose(); }}>
            <div
                className={style.modalContent}
                onClick={(e) => e.stopPropagation()}>
                <div className={style.modalContentContainer}>
                    {!isDeleting ?
                        <>
                            <div className={style.modalHeader}>
                                <svg width="15" height="18" viewBox="0 0 15 18" fill="none">
                                    <path d="M9.20454 0C9.54 0 9.81818 0.278183 9.81818 0.613638V1.63637H14.1136C14.4491 1.63637 14.7273 1.91455 14.7273 2.25001V2.6591C14.7273 2.99455 14.4491 3.27274 14.1136 3.27274H0.613636C0.45089 3.27274 0.294809 3.20809 0.17973 3.09301C0.0646507 2.97793 0 2.82185 0 2.6591V2.25001C0 1.91455 0.278182 1.63637 0.613636 1.63637H4.90909V0.613638C4.90909 0.278183 5.18727 0 5.52273 0H9.20454Z" fill="#D4D4D4" />
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M1.68538 4.90918C1.57367 4.90898 1.46311 4.93165 1.36051 4.97581C1.2579 5.01996 1.16542 5.08466 1.08876 5.16591C1.01211 5.24716 0.952907 5.34325 0.914801 5.44825C0.876695 5.55326 0.860494 5.66495 0.867197 5.77646L1.48902 15.701C1.52859 16.3247 1.80457 16.9098 2.26066 17.337C2.71676 17.7642 3.31863 18.0014 3.94356 18.0001H10.7836C11.4085 18.0014 12.0104 17.7642 12.4665 17.337C12.9226 16.9098 13.1985 16.3247 13.2381 15.701L13.8517 5.77646C13.8584 5.66495 13.8422 5.55326 13.8041 5.44825C13.766 5.34325 13.7068 5.24716 13.6302 5.16591C13.5535 5.08466 13.461 5.01996 13.3584 4.97581C13.2558 4.93165 13.1453 4.90898 13.0336 4.90918H1.69356H1.68538ZM6.54538 9.0001C6.54538 8.78311 6.45918 8.575 6.30574 8.42156C6.1523 8.26812 5.94419 8.18192 5.7272 8.18192C5.5102 8.18192 5.30209 8.26812 5.14865 8.42156C4.99522 8.575 4.90901 8.78311 4.90901 9.0001V13.9092C4.90901 14.1262 4.99522 14.3343 5.14865 14.4878C5.30209 14.6412 5.5102 14.7274 5.7272 14.7274C5.94419 14.7274 6.1523 14.6412 6.30574 14.4878C6.45918 14.3343 6.54538 14.1262 6.54538 13.9092V9.0001ZM8.99992 8.18192C9.21692 8.18192 9.42503 8.26812 9.57846 8.42156C9.7319 8.575 9.8181 8.78311 9.8181 9.0001V13.9092C9.8181 14.1262 9.7319 14.3343 9.57846 14.4878C9.42503 14.6412 9.21692 14.7274 8.99992 14.7274C8.78293 14.7274 8.57482 14.6412 8.42138 14.4878C8.26794 14.3343 8.18174 14.1262 8.18174 13.9092V9.0001C8.18174 8.78311 8.26794 8.575 8.42138 8.42156C8.57482 8.26812 8.78293 8.18192 8.99992 8.18192Z" fill="#D4D4D4" />
                                </svg>
                                <a>Are you sure you want to delete the project</a>
                                <text>{projectTitle}</text>
                                <span>You will lose access to project resources.</span>
                            </div>
                            <div className={style.modalButtons}>
                                <div
                                    className={style.deleteButton}
                                    onClick={() => {
                                        setCountDeleteClick(countDeleteClick - 1);
                                        if (countDeleteClick == 0)
                                            deleteProject();
                                    }}
                                    style={{ opacity: isLoading ? 0.5 : 1 }}>
                                    Delete
                                    {countDeleteClick > 0 && <a>{countDeleteClick}</a>}
                                </div>
                                <div
                                    className={style.closeButton}
                                    onClick={() => { onClose(); }}>
                                    Cancel
                                </div>
                            </div>
                        </>
                        :
                        <div className={style.modalHeader}>
                            <svg width="15" height="18" viewBox="0 0 15 18" fill="none">
                                <path d="M9.20454 0C9.54 0 9.81818 0.278183 9.81818 0.613638V1.63637H14.1136C14.4491 1.63637 14.7273 1.91455 14.7273 2.25001V2.6591C14.7273 2.99455 14.4491 3.27274 14.1136 3.27274H0.613636C0.45089 3.27274 0.294809 3.20809 0.17973 3.09301C0.0646507 2.97793 0 2.82185 0 2.6591V2.25001C0 1.91455 0.278182 1.63637 0.613636 1.63637H4.90909V0.613638C4.90909 0.278183 5.18727 0 5.52273 0H9.20454Z" fill="#D4D4D4" />
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M1.68538 4.90918C1.57367 4.90898 1.46311 4.93165 1.36051 4.97581C1.2579 5.01996 1.16542 5.08466 1.08876 5.16591C1.01211 5.24716 0.952907 5.34325 0.914801 5.44825C0.876695 5.55326 0.860494 5.66495 0.867197 5.77646L1.48902 15.701C1.52859 16.3247 1.80457 16.9098 2.26066 17.337C2.71676 17.7642 3.31863 18.0014 3.94356 18.0001H10.7836C11.4085 18.0014 12.0104 17.7642 12.4665 17.337C12.9226 16.9098 13.1985 16.3247 13.2381 15.701L13.8517 5.77646C13.8584 5.66495 13.8422 5.55326 13.8041 5.44825C13.766 5.34325 13.7068 5.24716 13.6302 5.16591C13.5535 5.08466 13.461 5.01996 13.3584 4.97581C13.2558 4.93165 13.1453 4.90898 13.0336 4.90918H1.69356H1.68538ZM6.54538 9.0001C6.54538 8.78311 6.45918 8.575 6.30574 8.42156C6.1523 8.26812 5.94419 8.18192 5.7272 8.18192C5.5102 8.18192 5.30209 8.26812 5.14865 8.42156C4.99522 8.575 4.90901 8.78311 4.90901 9.0001V13.9092C4.90901 14.1262 4.99522 14.3343 5.14865 14.4878C5.30209 14.6412 5.5102 14.7274 5.7272 14.7274C5.94419 14.7274 6.1523 14.6412 6.30574 14.4878C6.45918 14.3343 6.54538 14.1262 6.54538 13.9092V9.0001ZM8.99992 8.18192C9.21692 8.18192 9.42503 8.26812 9.57846 8.42156C9.7319 8.575 9.8181 8.78311 9.8181 9.0001V13.9092C9.8181 14.1262 9.7319 14.3343 9.57846 14.4878C9.42503 14.6412 9.21692 14.7274 8.99992 14.7274C8.78293 14.7274 8.57482 14.6412 8.42138 14.4878C8.26794 14.3343 8.18174 14.1262 8.18174 13.9092V9.0001C8.18174 8.78311 8.26794 8.575 8.42138 8.42156C8.57482 8.26812 8.78293 8.18192 8.99992 8.18192Z" fill="#D4D4D4" />
                            </svg>
                            <a>You delete the project</a>
                            <text>{projectTitle}</text>
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                <path d="M11.1733 16.0001L14.3867 19.2268L20.8267 12.7734" stroke="#C6FD8F" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M14.3333 3.26676C15.2533 2.48009 16.76 2.48009 17.6933 3.26676L19.8 5.08009C20.2 5.42676 20.9467 5.70676 21.48 5.70676H23.7467C25.16 5.70676 26.32 6.86676 26.32 8.28009V10.5468C26.32 11.0668 26.6 11.8268 26.9467 12.2268L28.76 14.3334C29.5467 15.2534 29.5467 16.7601 28.76 17.6934L26.9467 19.8001C26.6 20.2001 26.32 20.9468 26.32 21.4801V23.7468C26.32 25.1601 25.16 26.3201 23.7467 26.3201H21.48C20.96 26.3201 20.2 26.6001 19.8 26.9468L17.6933 28.7601C16.7733 29.5468 15.2667 29.5468 14.3333 28.7601L12.2267 26.9468C11.8267 26.6001 11.08 26.3201 10.5467 26.3201H8.24001C6.82667 26.3201 5.66667 25.1601 5.66667 23.7468V21.4668C5.66667 20.9468 5.38667 20.2001 5.05334 19.8001L3.25334 17.6801C2.48001 16.7601 2.48001 15.2668 3.25334 14.3468L5.05334 12.2268C5.38667 11.8268 5.66667 11.0801 5.66667 10.5601V8.26676C5.66667 6.85342 6.82667 5.69342 8.24001 5.69342H10.5467C11.0667 5.69342 11.8267 5.41342 12.2267 5.06676L14.3333 3.26676Z" stroke="#C6FD8F" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                    }
                </div>
            </div>
        </div>
    )
};

export default DeleteProjectModal;
